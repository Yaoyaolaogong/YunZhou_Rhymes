<template>
  <div :class="{ dark: isDarkMode }" class="min-h-screen transition bg-gradient-to-br from-yellow-50 to-yellow-200 dark:from-gray-800 dark:to-gray-900 text-gray-800 dark:text-gray-100">
    <div class="max-w-5xl mx-auto py-10 px-6">
      <!-- é¡¶éƒ¨æ ‡é¢˜ä¸æ§åˆ¶æŒ‰é’® -->
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-4xl font-extrabold text-yellow-700 dark:text-yellow-300">ğŸ“œ è¯—è¯æœç´¢</h2>
        <button @click="toggleDarkMode" class="text-3xl hover:scale-110 transition text-yellow-700 dark:text-yellow-300">
          {{ isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™' }}
        </button>
      </div>

      <!-- æ§åˆ¶åŒºï¼šå­—ä½“æŒ‰é’®å’Œæœç´¢æ¡† -->
      <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
        <!-- å­—ä½“å¤§å°æŒ‰é’® -->
        <div class="flex gap-3">
          <button @click="adjustFontSize(-1)" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-lg shadow hover:bg-yellow-500 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition">Aâ»</button>
          <button @click="adjustFontSize(1)" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-lg shadow hover:bg-yellow-500 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition">Aâº</button>
        </div>

        <!-- æœç´¢æ¡† + æœç´¢æŒ‰é’® -->
        <div class="flex w-full md:w-auto gap-3">
          <input
            v-model="searchQuery"
            type="text"
            :style="{ fontSize: fontSize + 'px' }"
            placeholder="è¯·è¾“å…¥ä½œè€…ã€æ ‡é¢˜æˆ–è¯—å¥ç‰‡æ®µ"
            class="flex-1 px-4 py-2 border border-yellow-500 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-yellow-600 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition"
          />
          <button
            @click="searchPoetry"
            class="px-5 py-2 bg-yellow-600 text-white rounded-lg shadow hover:bg-yellow-700 transition"
          >
            ğŸ” æœç´¢
          </button>
        </div>
      </div>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="loading" class="text-center text-blue-500 my-6 text-lg font-medium">
        æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™...
      </div>

      <!-- æœç´¢ç»“æœ -->
      <transition-group v-if="sortedResults.length" name="fade" tag="div" class="space-y-4">
        <div
          v-for="(poem, index) in sortedResults"
          :key="poem.id"
          class="relative bg-white dark:bg-gray-700 p-6 rounded-lg shadow-md border-l-4 border-yellow-500 hover:shadow-lg transition transform hover:-translate-y-1 cursor-pointer"
          @click="goToDetail(poem.id)"
          :style="{ fontSize: fontSize + 'px' }"
        >
          <!-- æ”¶è—æŒ‰é’® -->
          <button
            class="absolute top-3 right-3 text-xl text-red-500 hover:scale-110 transition"
            @click.stop="toggleFavorite(poem.id)"
            :title="isFavorite(poem.id) ? 'å–æ¶ˆæ”¶è—' : 'åŠ å…¥æ”¶è—'"
          >
            {{ isFavorite(poem.id) ? 'â¤ï¸' : 'ğŸ¤' }}
          </button>

          <!-- æ ‡é¢˜å’Œå†…å®¹ -->
          <h3 class="text-xl font-semibold mb-2">
            {{ poem.title }} <span class="text-sm text-gray-500 dark:text-gray-300">- {{ poem.author }}</span>
          </h3>
          <p class="whitespace-pre-line text-gray-700 dark:text-gray-200 leading-relaxed">
            {{ poem.content }}
          </p>
        </div>
      </transition-group>

      <!-- æ— ç»“æœæç¤º -->
      <div v-if="searched && !loading && sortedResults.length === 0" class="text-center text-gray-500 dark:text-gray-300 mt-10 text-lg">
        ğŸ¤” æ²¡æ‰¾åˆ°ç›¸å…³è¯—è¯ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'PoetrySearch',
  data() {
    return {
      searchQuery: '',
      results: [],
      searched: false,
      loading: false,
      favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
      fontSize: 16,
      isDarkMode: JSON.parse(localStorage.getItem('darkMode') || 'false'),
      poetryData: [
        {
          id: 1,
          title: 'é™å¤œæ€',
          author: 'æç™½',
          content: 'åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚'
        },
        {
          id: 2,
          title: 'æ˜¥æ™“',
          author: 'å­Ÿæµ©ç„¶',
          content: 'æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚'
        },
        {
          id: 3,
          title: 'ç™»é¹³é›€æ¥¼',
          author: 'ç‹ä¹‹æ¶£',
          content: 'ç™½æ—¥ä¾å±±å°½ï¼Œé»„æ²³å…¥æµ·æµã€‚\næ¬²ç©·åƒé‡Œç›®ï¼Œæ›´ä¸Šä¸€å±‚æ¥¼ã€‚'
        },
        {
          id: 4,
          title: 'æœ›åºå±±ç€‘å¸ƒ',
          author: 'æç™½',
          content: 'æ—¥ç…§é¦™ç‚‰ç”Ÿç´«çƒŸï¼Œé¥çœ‹ç€‘å¸ƒæŒ‚å‰å·ã€‚\né£æµç›´ä¸‹ä¸‰åƒå°ºï¼Œç–‘æ˜¯é“¶æ²³è½ä¹å¤©ã€‚'
        }
      ]
    };
  },
  computed: {
    sortedResults() {
      return [...this.results].sort((a, b) => {
        const aFav = this.isFavorite(a.id) ? 0 : 1;
        const bFav = this.isFavorite(b.id) ? 0 : 1;
        return aFav - bFav;
      });
    }
  },
  methods: {
    searchPoetry() {
      this.searched = false;
      this.results = [];

      if (!this.searchQuery.trim()) {
        alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
        return;
      }

      this.loading = true;

      setTimeout(() => {
        const query = this.searchQuery.trim().toLowerCase();
        const results = this.poetryData.filter(poem =>
          poem.title.toLowerCase().includes(query) ||
          poem.author.toLowerCase().includes(query) ||
          poem.content.toLowerCase().includes(query)
        );
        this.results = results;
        this.loading = false;
        this.searched = true;
      }, 400);
    },
    goToDetail(id) {
      this.$router.push(`/poem/${id}`);
    },
    isFavorite(id) {
      return this.favorites.includes(id);
    },
    toggleFavorite(id) {
      if (this.isFavorite(id)) {
        this.favorites = this.favorites.filter(f => f !== id);
      } else {
        this.favorites.push(id);
      }
      localStorage.setItem('favorites', JSON.stringify(this.favorites));
    },
    adjustFontSize(delta) {
      this.fontSize = Math.max(12, this.fontSize + delta);
    },
    toggleDarkMode() {
      this.isDarkMode = !this.isDarkMode;
      localStorage.setItem('darkMode', JSON.stringify(this.isDarkMode));
    }
  }
};
</script>

<style scoped>
.fade-enter-active, .fade-leave-active {
  transition: all 0.3s ease;
}
.fade-enter-from, .fade-leave-to {
  opacity: 0;
  transform: translateY(10px);
}
</style>
